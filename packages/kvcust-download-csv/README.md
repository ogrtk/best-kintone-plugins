# kViewer CSV一括ダウンロードスクリプト

## 概要

kViewerのリストビューにおいて、**表示されているレコードをCSV形式でダウンロード**するためのJavaScriptカスタマイズスクリプトです。
サブテーブル（テーブルフィールド）にも対応しており、1レコードが複数行に展開されるCSV出力が可能です。

## 主な機能

* **CSVダウンロードボタンの自動追加**: リストビュー表示時にダウンロードボタンを自動で配置
* **サブテーブル対応**: テーブルフィールドの行数分、レコードを展開して出力
* **フィールド選択**: 出力するフィールドと順序を設定で指定可能
* **開始行マーク**: サブテーブル展開時、レコードの先頭行に `*` マークを表示
* **BOM設定**: Excel互換のためBOM付きUTF-8、または一般的なBOMなしUTF-8を選択可能
* **改行コード設定**: Windows (CRLF)、Unix/Mac (LF)、古いMac (CR) を選択可能
* **File System Access API対応**: モダンブラウザ（Chrome/Edge）では前回の保存先フォルダを記憶
* **設定検証**: スクリプト読み込み時に設定の妥当性を自動チェック

## 使用方法

### 1. kViewer リストビューのカスタマイズ設定

#### JavaScriptカスタマイズ登録

* 本スクリプトを kViewer のカスタマイズJavaScriptとして登録します
* スクリプト内の `CSV_CONFIG` と `STYLE_CONFIG` を編集して必要な設定を行います

### 2. CSV出力設定 (CSV_CONFIG)

#### 必須設定

| 設定キー | 内容 | 例 |
|---------|------|-----|
| `fields` | 出力するフィールドコードの配列（順番に出力） | `["案件名", "日付", "質疑.質問"]` |
| `encoding.includeBOM` | BOM付きUTF-8で出力するか | `true` (Excel向け) / `false` (一般向け) |
| `encoding.lineBreak` | 改行コード | `"\r\n"` (Windows) / `"\n"` (Unix/Mac) |

#### フィールド指定方法

```javascript
fields: [
  "案件名",              // 通常フィールド
  "日付",                // 通常フィールド
  "質疑.質問",           // サブテーブル.フィールド
  "質疑.回答",           // サブテーブル.フィールド
]
```

**重要**: サブテーブルのフィールドは `テーブルコード.フィールドコード` の形式で指定してください。

### 3. スタイル設定 (STYLE_CONFIG)

UI要素の見た目をカスタマイズできます**（通常は変更不要）**。

| 設定キー | 内容 |
|---------|------|
| `recordMenu` | kv-record-menuの高さやパディング |
| `downloadButton` | ダウンロードボタンのテキスト、スタイル、透明度 |
| `icon` | アイコンSVG |
| `textLabel` | テキストラベルのスタイル |
| `buttonContainer` | ボタンコンテナのパディング |

## CSV出力形式

### 基本的な出力例

```csv
*開始行,案件名,担当者
*,プロジェクトA,田中太郎
*,プロジェクトB,佐藤花子
```

### サブテーブルを含む場合

サブテーブルが2行ある場合、レコードは2行に展開されます：

```csv
*開始行,案件名,質疑.質問,質疑.回答
*,プロジェクトA,質問1,回答1
,プロジェクトA,質問2,回答2
*,プロジェクトB,質問A,回答A
```

* **`*開始行`列**: レコードの開始行に `*`、継続行は空白
* **通常フィールド**: サブテーブル展開時も同じ値を繰り返し出力
* **サブテーブルフィールド**: 各行の値を出力

## ブラウザ対応

| ブラウザ | ダウンロード方式 | フォルダ記憶 |
|---------|----------------|------------|
| Chrome 86+ | File System Access API | ✅ 対応 |
| Edge 86+ | File System Access API | ✅ 対応 |
| Safari | Blob + download属性 | ❌ 非対応 |
| Firefox | Blob + download属性 | ❌ 非対応 |

## 動作フロー

1. リストビュー表示時、`records.show` イベントを検知
2. `.kv-list` が存在する場合のみ、ダウンロードボタンを配置
3. ボタンクリック時、確認ダイアログを表示
4. `context.records` から表示中のレコードデータを取得
5. 設定に基づいてCSV文字列を生成
6. File System Access API（対応ブラウザ）またはBlob方式でダウンロード

## エラーハンドリング

### 設定エラー

スクリプト読み込み時に以下をチェックし、エラーがあればアラート表示：

* `CSV_CONFIG.fields` が配列で、要素が1つ以上あること
* `CSV_CONFIG.encoding.includeBOM` がboolean値であること
* `CSV_CONFIG.encoding.lineBreak` が有効な改行コード (`\r\n`, `\n`, `\r`) であること

### 実行時エラー

* レコード取得失敗時: エラーメッセージをアラート表示
* ダウンロードキャンセル時: エラーメッセージを表示
* その他の例外: コンソールにエラーログを出力

## 注意事項

* **リストビュー専用**: カレンダービューや詳細ビューでは動作しません
* **表示中のレコードのみ**: 画面に表示されているレコードのみダウンロード対象です（全件ダウンロードではありません）
* **フィールドコードの確認**: kintone/kViewerのフィールドコードを正確に指定してください
* **サブテーブルの指定**: ドット記法 (`テーブル.フィールド`) で指定する必要があります
* **設定必須**: `CSV_CONFIG.fields` が空の場合、エラーになります

## カスタマイズ例

### Excel向けの設定

```javascript
const CSV_CONFIG = {
  fields: ["案件名", "日付", "担当者"],
  encoding: {
    includeBOM: true,      // BOM付き
    lineBreak: "\r\n",     // Windows改行
  },
};
```

### Unix/Linux向けの設定

```javascript
const CSV_CONFIG = {
  fields: ["案件名", "日付", "担当者"],
  encoding: {
    includeBOM: false,     // BOMなし
    lineBreak: "\n",       // Unix改行
  },
};
```

## トラブルシューティング

### ボタンが表示されない

* ブラウザのコンソールでエラーを確認してください
* `.kv-list` 要素が存在するか確認してください（リストビューでのみ動作）
* 設定エラーがないか確認してください

### 文字化けする

* Excel で開く場合: `includeBOM: true` に設定
* テキストエディタで開く場合: `includeBOM: false` に設定

### フィールドが出力されない

* `CSV_CONFIG.fields` に正しいフィールドコードが設定されているか確認
* サブテーブルは `テーブルコード.フィールドコード` 形式で指定

## 参考

* [kViewer カスタマイズ v2 ドキュメント](https://kviewer.kintoneapp.com/help/customize/v2)
* [File System Access API](https://developer.mozilla.org/en-US/docs/Web/API/File_System_API)
